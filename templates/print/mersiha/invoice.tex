\documentclass[paper=a4,fontsize=10pt]{scrartcl}
\usepackage{kiviletter}
\usepackage{xstring}
<%if template_meta.formname == "invoice_copy"%>
  \usepackage{transparent}
  \DeclareNewLayer[page,foreground,contents={
    \parbox[c][\layerheight][c]{\layerwidth}{\centering\color{gray}\scalebox{11}{\rotatebox{60}{\texttransparent{0.5}{\rechnungskopie}}}}
  }]{foreground}
  \AddLayersToPageStyle{kivitendo.letter.first}{foreground}%Hintergrund für die erste Seite aktivieren
  \AddLayersToPageStyle{kivitendo.letter}{foreground}%Hintergrund für die erste Seite aktivieren
<%end template_meta.formname == "invoice_copy"%>




% Variablen, die in settings verwendet werden
\newcommand{\lxlangcode} {<%template_meta.language.template_code%>}
\newcommand{\lxmedia} {<%media%>}
\newcommand{\lxcurrency} {<%currency%>}
\newcommand{\kivicompany} {<%employee_company%>}

% settings: Einstellungen, Logo, Briefpapier, Kopfzeile, Fusszeile
\input{insettings.tex}

<%if template_meta.formname == "invoice_for_advance_payment"%>
  \renewcommand{\rechnung}{\anzahlungsrechnung}
<%end template_meta.formname == "invoice_for_advance_payment"%>

<%if template_meta.formname == "final_invoice"%>
  \renewcommand{\rechnung}{\schlussrechnung}
<%end template_meta.formname == "final_invoice"%>

<%if template_meta.formname == "storno_invoice"%>
  \renewcommand{\rechnung}{\stornorechnung}

<%end template_meta.formname == "storno_invoice"%>

% laufende Kopfzeile:
\ourhead{\kundennummer}{<%customernumber%>}{\rechnung}{<%invnumber%>}{<%invdate%>}

\setkomavar{info0}[\vorgangsbez]       {<%transaction_description%>}
\setkomavar{info1}[\rechnungsdatum]    {<%invdate%>}
\setkomavar{info2}[\kundennummer]      {<%customernumber%>}
\setkomavar{info3}[\ihreBestellnummer] {<%cusordnumber%>}
\setkomavar{info4}[\auftragsnummer]    {<%ordnumber%>}
\setkomavar{info5}[\angebot{}~\nr]     {<%quonumber%>}
\setkomavar{info6}[\lieferschein{}~\nr]{<%donumber%>}
\setkomavar{info7}[\leistungsdatum]    {<%tax_point%>}
\setkomavar{info8}[\ansprechpartner]   {<%employee_name%>}
\setkomavar{info9}[\textTelefon]       {<%employee_tel%>}
\setkomavar{info10}[\textEmail]        {<%employee_email%>}
\setkomavar{fromname}                  {<%employee_name%>}

<%if template_meta.formname == "storno_invoice"%>
  \setkomavar{title}{\rechnungs-<%invnumber%>}

  \setkomavar{info5}[\rechnung~\nr]    {\StrSubstitute{<%invnumber%>}{Storno zu }{}}
<%else%>
  \setkomavar{title}{\rechnung~\nr~<%invnumber%>}
<%end%>


<%if shiptoname%>%
  \makeatletter
  \begin{lrbox}\shippingAddressBox
    \parbox{\useplength{toaddrwidth}}{
      \backaddr@format{\scriptsize\usekomafont{backaddress}%
        \strut\abweichendeLieferadresse
      }
      \par\smallskip
      \setlength{\parskip}{\z@}
      \par
      \normalsize
      <%shiptoname%>\par
      <%shiptodepartment_1%>\par
      <%shiptodepartment_2%>\par
      <%if shiptocontact%> <%shiptocontact%><%else%><%cp_title%> <%cp_givenname%> <%cp_name%><%end if%>\par
      <%shiptostreet%>\par
      <%shiptozipcode%> <%shiptocity%>\par
      <%shiptocountry%>
    }
  \end{lrbox}
  \makeatother
<%end shiptoname%>%

\begin{document}

\begin{letter}{
  <%if billing_address_id%> %
    <%billing_address_name%>         \strut\\
    <%billing_address_department_1%> \ifhmode\\\fi
    <%billing_address_department_2%> \ifhmode\\\fi
    <%cp_title%> <%cp_givenname%> <%cp_name%> \ifhmode\\\fi
    <%billing_address_street%>       \ifhmode\\\fi
    <%billing_address_zipcode%> <%billing_address_city%> \ifhmode\\\fi
    <%billing_address_country%>      %
  <%else%> %
    <%name%>                         \strut\\
    <%department_1%>                 \ifhmode\\\fi
    <%department_2%>                 \ifhmode\\\fi
    <%cp_title%> <%cp_givenname%> <%cp_name%> \ifhmode\\\fi
    <%street%>                       \ifhmode\\\fi
    <%zipcode%> <%city%>             \ifhmode\\\fi
    <%country%>                      %
  <%end%> %
  }

  % Bei Kontaktperson Anrede nach Geschlecht unterscheiden.
  % Bei natürlichen Personen persönliche Anrede, sonst allgemeine Anrede.
  \opening{
    \Ifstr{<%cp_name%>}{}
    {<%if natural_person%><%greeting%> <%name%>,<%else%>\anrede<%end if%>}
    {
      \Ifstr{<%cp_gender%>}{f}
      {\anredefrau}
      {\anredeherr}
      <%cp_title%> <%cp_name%>,
    }
  }
  \thispagestyle{kivitendo.letter.first}

  <%if template_meta.formname == "storno_invoice"%>
    \stornoErstatten{\StrSubstitute{<%invnumber%>}{Storno zu }{}}
  <%else%>
    \rechnungsformel
  <%end%>

  <%if notes%>%
    <%notes%>%
    \vspace{0.5cm}
  <%end notes%>%


  \begin{PricingTabular*}[price/colspec = K, pricetotal/colspec = K]
    % eigentliche Tabelle
    \FakeTable{%
    <%foreach number%>%
      <%runningnumber%> &%
      <%number%> &%
      \textbf{<%description%>}%
      <%if longdescription%>\ExtraDescription{<%longdescription%>}<%end longdescription%>%
      <%if serialnumber%>\ExtraDescription{\seriennummer: <%serialnumber%>}<%end serialnumber%>%
      <%if ean%>\ExtraDescription{\ean: <%ean%>}<%end ean%>%
      <%if projectnumber%>\ExtraDescription{\projektnummer: <%projectnumber%>}<%end projectnumber%>%
      &%
      <%qty%> <%unit%> &%
      <%sellprice%>\,\currency&%
      <%if optional%>\optional<%else%><%linetotal%>\,\currency<%if p_discount%>\par{\sffamily\scriptsize{(-<%p_discount%>\,\%)}}<%end p_discount%><%end optional%>
      \tabularnewline
      <%if discount_sub%>
        \rlap{\zwischensumme}& & & & &
        <%discount_sub%>\,\currency
        \tabularnewline
      <%end%>
    <%end number%>%
    }%
    \begin{PricingTotal}%
      % Tabellenende letzte Seite
      \nettobetrag & <%subtotal%>\\%
      <%foreach tax%>%
        <%taxdescription%> & <%tax%>\\%
      <%end tax%>%
      \bfseries\schlussbetrag &  \bfseries <%invtotal%>\\%
    \end{PricingTotal}%
  \end{PricingTabular*}

  \vspace{0.2cm}

  <%if template_meta.formname == "final_invoice"%>
  <%if iap_existing%>
    \abzueglichAnzahlungsrechnungen:\\
    \begin{SimpleTabular}[colspec=llr<{\tabcurrency}r<{\tabcurrency},headline={\bfseries\nr& \bfseries\date& \bfseries\betrag & \bfseries\ust}]%
      <%foreach iap_invnumber%>%
        <%iap_invnumber%> & <%iap_transdate_as_date%> & <%iap_amount%> & <%iap_taxamount%>\\%
      <%end iap_invnumber%>%
    \end{SimpleTabular}%
    \textbf{\rechnungsbetrag: <%iap_final_amount%> \currency} \\%
  <%end iap_existing%>
  <%end%>%

  \Ifstr{<%deliverydate%>}{}{%
    \leistungsdatumGleichRechnungsdatum%
  }{
    \lieferungErfolgtAm ~<%deliverydate%>.
  }\\

  <%if template_meta.formname != "storno_invoice"%>%
    <%if payment_terms%>%
      \zahlung ~<%payment_terms%>\\
    <%end payment_terms%>%

    <%if delivery_term%>%
      \lieferung ~<%delivery_term.description_long%>\\
    <%end delivery_term%>%
  <%end template_meta.formname != "storno_invoice"%>%

  <%if ustid%>\ihreustid ~<%ustid%>.\\<%end if%>%

  \ifnum<%taxzone_id%>=1
    \steuerfreiEU\\  % EU mit USt-ID Nummer
  \else
    \ifnum<%taxzone_id%>=3
      \steuerfreiAUS\\  % Außerhalb EU
    \fi
  \fi

  \closing{\gruesse}

\end{letter}

\end{document}
