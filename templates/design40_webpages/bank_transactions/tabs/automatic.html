[% USE HTML %]
[% USE LxERP %]
[% USE L %]
[% USE T8 %]

<form method="post" id="list_automatic_form">
[% L.hidden_tag('filter.bank_account', FORM.filter.bank_account) %]
[% L.hidden_tag('filter.fromdate', FORM.filter.fromdate) %]
[% L.hidden_tag('filter.todate',   FORM.filter.todate) %]
[% L.hidden_tag('action', 'BankTransaction/dispatch') %]
[% L.hidden_tag('ui_tab', ui_tab) %]

<table id="bank_transactions_proposals" class="tbl-list">
  <thead>
    <tr>
      <th>[% L.checkbox_tag('check_all') %]</th>
      <th>[% 'Type' | $T8 %]</th>
      <th>[% 'ID' | $T8 %]</th>
      <th>[% 'Transdate' | $T8 %]</th>
      <th>[% 'Amount' | $T8 %]</th>
      <th>[% 'Skonto' | $T8 %]</th>
      <th>[% 'Purpose/Reference' | $T8 %]</th>
      <th>[% 'Customer/Vendor/Remote name' | $T8 %]</th>
      <th>[% LxERP.t8("Source") %]</th>
      <th>[% LxERP.t8("Memo") %]</th>
    </tr>
  </thead>
  <tbody>
  [% IF !PROPOSALS.size %]
    <td colspan="10"><p class="message message_hint center">[% 'No data was found.' | $T8 %]</p></td>
  [% ELSE %]
    [% FOREACH proposal = PROPOSALS %]
      <tr>
        <td rowspan=[% proposal.rowspan %] style="valign:center;">
          [% L.checkbox_tag('proposal_ids[]', checked=0, value=proposal.id) %]
        </td>
        <td>[% HTML.escape(proposal.transaction_text) %]</td>
        <td>[% proposal.id %]</td>
        <td>[% proposal.transdate_as_date %]</td>
        <td>[% LxERP.format_amount(proposal.amount,2) %]</td>
        <td></td>
        <td>[%
            SET purpose = HTML.escape(proposal.purpose)
                invnumber_found = '' ;
            FOREACH proposed_invoice = proposal.proposals;
              IF purpose.match(proposed_invoice.invnumber);
                SET invnumber_found = proposed_invoice.invnumber ;
              END ;
            END ;

            IF invnumber_found ;
              purpose.replace(invnumber_found, '<span class="invoice_number_highlight">' _ invnumber_found _ '</span>') ;
            ELSE ;
              purpose ;
            END
        %]</td>
        <td>[% HTML.escape(proposal.remote_name) %]</td>
        <td></td>
        <td></td>
      </tr>

      [% FOREACH proposed_invoice = proposal.proposals %]
        <tr>
          <td></td>
          <td>[% 'Invoice' | $T8 %]</td>
          <td>[% proposed_invoice.id %]</td>
          <td>[% proposed_invoice.transdate_as_date %]
              [% L.hidden_tag("invoice_ids." _ proposal.id _ "[]", proposed_invoice.id) %]</td>
          <td>[% proposed_invoice.realamount %]</td>
          <td>[% proposed_invoice.skonto_type | $T8 %]
              [% L.hidden_tag("invoice_skontos." _ proposal.id _ "[]", proposed_invoice.skonto_type) %]</td>
          <td[% IF proposed_invoice.invnumber == invnumber_found %] class="invoice_number_highlight"[% END %]>[% proposed_invoice.link %]</td>
          <td>[% HTML.escape(proposed_invoice.customer.name) %][% HTML.escape(proposed_invoice.vendor.name) %]</td>
          <td>[% L.input_tag("sources." _ proposal.id _ "[]", "", size=20) %]</td>
          <td>[% L.input_tag("memos." _ proposal.id _ "[]", "", size=20) %]</td>
        </tr>
      [% END %]

        <tr><td style="height:10px" colspan="10"></td></tr>
      </tbody>
    [% END %]
  [% END %]
</table>

<div class="buttons">
 [% L.submit_tag('action_save_proposals', LxERP.t8('Save proposals')) %]
 [% L.button_tag('kivi.BankTransaction.show_set_all_sources_memos_dialog("#list_automatic_form [name^=\\"sources.\\"]", "#list_automatic_form [name^=\\"memos.\\"]")', LxERP.t8('Set all source and memo fields'), class='neutral') %]
</div>

</form>
