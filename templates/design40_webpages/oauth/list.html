[%- USE HTML -%]
[%- USE P -%]
[%- USE T8 -%]
[%- INCLUDE 'common/flash.html' %]

<h1>[% HTML.escape(title) %]</h1>

<div class="wrapper">
<table class="tbl-list">
  <thead>
    <tr>
      <th>ID</th>
      <th>[% 'Provider' | $T8 %]</th>
      [% IF (AUTH.assert('admin', 'may_fail')) %]
        <th>[% 'Valid user' | $T8 %]</th>
      [% END %]
      <th>[% 'Email' | $T8 %] / scope</th>
      <th>state</th>
      <th>[% 'expires in (s)' | $T8 %]</th>
      <th>access token</th>
      <th>refresh token</th>
      <th>[% 'delete' | $T8 %]</th>
    </tr>
  </thead>
  <tbody>
    [%- FOREACH tok = TOKENS %]
    <tr>
      <td class="right">[% HTML.escape(tok.id) %]</td>
      <td>[% HTML.escape(tok.provider) %]</td>
      [% IF (AUTH.assert('admin', 'may_fail')) %]
        <td>[% IF tok.employee %][% HTML.escape(tok.employee) %][% ELSE %]<i>[% 'client-wide' | $T8 %]</i>[% END %]</td>
      [% END %]
      <td>[% HTML.escape(tok.email) %][% IF tok.scope %] [% P.context_help_tag(tok.scope) %][% END %]</td>
      <td>[% HTML.escape(tok.tokenstate) %]</td>
      <td class="right">[% HTML.escape(tok.expiration) %]</td>
      <td class="right">[% HTML.escape(tok.access_token) %]</td>
      <td class="right">[% HTML.escape(tok.refresh_token) %]</td>
      <td class="center"><input type="button" onclick="ask_delete_token([% tok.id %])" tag="input" value="X"></td>
    </tr>
    [%- END %]
  </tbody>
</table>
</div>

<script>
function ask_delete_token(id) {
  if (!confirm('Sind Sie sicher?')) return;

  var data = [
    { name: 'action', value: 'OAuth/delete_token' },
    { name: 'id', value: id }];

  $.post("controller.pl", data, kivi.eval_json_result);
}
</script>
