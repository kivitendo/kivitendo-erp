[% USE HTML %]
[% USE LxERP %]
[% USE L %]
[% USE T8 %]
[% L.stylesheet_tag('webshop') %]

<h1>[% title %]</h1>

<!--
  PENDENT: Die DIV-Tables umwandeln in horizontale Tabellen.
  Vielleicht vorher mit Werner Hahn absprechen.
  Einzuege bitte so belassen wie hier, sonst hat man keine Uebersicht und findet die HTML-Fehler kaum!
  Solches Zeugs bitte schoener formatiert programmieren. Als Programmierer findet ja man sich so auch besser zurecht.
-->
<div class="wrapper" id="wrapper-1">

  <div class="input-panel control-panel">
    <form method="post" action="controller.pl" id="customer">
      [% L.hidden_tag('create_customer','customer') %]
      [% L.hidden_tag('import_id', IMPORT.id) %]
      <div class="col">
      <table class="tbl-horizontal col">
        <caption>[% 'Shop Customer Address' | $T8 %]</caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.customer_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Firstname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.customer_firstname) %]</td>
        </tr>
        <tr>
          <th>[% 'Lastname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.customer_lastname) %]</td>
        </tr>
        <tr>
          <th>[% 'Company' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.customer_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Department' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.customer_department) %]</td>
        </tr>
      </table>

        [% SET customer = IMPORT.customer_firstname _ ' ' _ IMPORT.customer_lastname %]

      <table class="tbl-horizontal col">
        <caption><hr></caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% L.input_tag('customer_greeting', IMPORT.customer_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Customer' | $T8 %]</th>
          <td>[% L.input_tag('customer_name', customer) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 2' | $T8 %]</th>
          <td>[% L.input_tag('customer_company', IMPORT.customer_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 3' | $T8 %]</th>
          <td>[% L.input_tag('customer_department', IMPORT.customer_department) %]</td>
        </tr>
        <tr>
          <th>[% 'Street' | $T8 %]</th>
          <td>[% L.input_tag('customer_street', IMPORT.customer_street) %]</td>
        </tr>
        <tr>
          <th>[% 'Zipcode' | $T8 %]</th>
          <td>[% L.input_tag('customer_zipcode', IMPORT.customer_zipcode) %]</td>
        </tr>
        <tr>
          <th>[% 'City' | $T8 %]</th>
          <td>[% L.input_tag('customer_city', IMPORT.customer_city) %]</td>
        </tr>
        <tr>
          <th>[% 'Country' | $T8 %]</th>
          <td>[% L.input_tag('customer_country', IMPORT.customer_country) %]</td>
        </tr>
        <tr>
          <th>[% 'Phone' | $T8 %]</th>
          <td>[% L.input_tag('customer_phone', IMPORT.customer_phone) %]</td>
        </tr>
        <tr>
          <th>[% 'Email' | $T8 %]</th>
          <td>[% L.input_tag('customer_email', IMPORT.customer_email) %]</td>
        </tr>

        [% IF C_ADDRESS %]
        <tr>
          <th>[% 'Customernumber' | $T8 %]</th>
          <td>[% C_ADDRESS.customernumber %]</td>
        </tr>
        [% ELSE %]
        <tr>
          <td colspan="2">
            [% L.ajax_submit_tag("controller.pl?action=ShopOrder/apply_customer",  "#customer", LxERP.t8("Apply customer")) %]
        </tr>
        [% END %]
      </table>
      </div>
    </form><!-- /#customer -->
  </div>

  <div class="input-panel control-panel">
    <form method="post" action="controller.pl" id="billing">
      [% L.hidden_tag('create_customer','billing') %]
      [% L.hidden_tag('import_id', IMPORT.id) %]

      <div class="col">
      <table class="tbl-horizontal col">
        <caption>[% 'Shop Billing Address' | $T8 %]</caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.billing_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Firstname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.billing_firstname) %]</td>
        </tr>
        <tr>
          <th>[% 'Lastname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.billing_lastname) %]</td>
        </tr>
        <tr>
          <th>[% 'Company' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.billing_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Department' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.billing_department) %]</td>
        </tr>
      </table>

        <!-- PENDENT: vielleicht neue Tabelle -->
        [% SET billing = IMPORT.billing_firstname _ ' ' _ IMPORT.billing_lastname %]

      <table class="tbl-horizontal col">
        <caption><hr></caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% L.input_tag('billing_greeting', IMPORT.billing_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Customer' | $T8 %]</th>
          <td>[% L.input_tag('billing_name', billing) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 2' | $T8 %]</th>
          <td>[% L.input_tag('billing_company', IMPORT.billing_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 3' | $T8 %]</th>
          <td>[% L.input_tag('billing_department', IMPORT.billing_department) %]</td>
        </tr>
        <tr>
          <th>[% 'Street' | $T8 %]</th>
          <td>[% L.input_tag('billing_street', IMPORT.billing_street) %]</td>
        </tr>
        <tr>
          <th>[% 'Zipcode' | $T8 %]</th>
          <td>[% L.input_tag('billing_zipcode', IMPORT.billing_zipcode) %]</td>
        </tr>
        <tr>
          <th>[% 'City' | $T8 %]</th>
          <td>[% L.input_tag('billing_city', IMPORT.billing_city) %]</td>
        </tr>
        <tr>
          <th>[% 'Country' | $T8 %]</th>
          <td>[% L.input_tag('billing_country', IMPORT.billing_country) %]</td>
        </tr>
        <tr>
          <th>[% 'Phone' | $T8 %]</th>
          <td>[% L.input_tag('billing_phone', IMPORT.billing_phone) %]</td>
        </tr>
        <tr>
          <th>[% 'Email' | $T8 %]</th>
          <td>[% L.input_tag('billing_email', IMPORT.billing_email) %]</td>
        </tr>
        [% IF D_ADDRESS %]
        <tr>
          <th>[% 'Customernumber' | $T8 %]</th>
          <td>[% D_ADDRESS.customernumber %]</td>
        </tr>
        [% ELSE %]
          <tr>
            <td colspan="2">
              [% L.ajax_submit_tag("controller.pl?action=ShopOrder/apply_customer",  "#delivery", LxERP.t8("Apply customer")) %]
            </td>
          </tr>
        [% END %]
      </table>
      </div>
    </form><!-- /#billing -->
  </div>

  <div class="input-panel control-panel">
    <form method="post" action="controller.pl" id="delivery">
      [% L.hidden_tag('create_customer','delivery') %]
      [% L.hidden_tag('import_id', IMPORT.id) %]
      <div class="col">
      <table class="tbl-horizontal col">
        <caption>[% 'Shop Delivery Address' | $T8 %]</caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.delivery_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Firstname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.delivery_firstname) %]</td>
        </tr>
        <tr>
          <th>[% 'Lastname' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.delivery_lastname) %]</td>
        </tr>
        <tr>
          <th>[% 'Company' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.delivery_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Department' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.delivery_department) %]</td>
        </tr>
      </table>

        [% SET delivery = IMPORT.delivery_firstname _ ' ' _ IMPORT.delivery_lastname %]

      <table class="tbl-horizontal col">
        <caption><hr></caption>
        <colgroup><col class="wi-verysmall"><col class="wi-mediumsmall"></colgroup>
        <tr>
          <th>[% 'Greeting' | $T8 %]</th>
          <td>[% L.input_tag('delivery_greeting', IMPORT.delivery_greeting) %]</td>
        </tr>
        <tr>
          <th>[% 'Customer' | $T8 %]</th>
          <td>[% L.input_tag('delivery_name', delivery) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 2' | $T8 %]</th>
          <td>[% L.input_tag('delivery_company', IMPORT.delivery_company) %]</td>
        </tr>
        <tr>
          <th>[% 'Name 3' | $T8 %]</th>
          <td>[% L.input_tag('delivery_department', IMPORT.delivery_department) %]</td>
        </tr>
        <tr>
          <th>[% 'Street' | $T8 %]</th>
          <td>[% L.input_tag('delivery_street', IMPORT.delivery_street) %]</td>
        </tr>
        <tr>
          <th>[% 'Zipcode' | $T8 %]</th>
          <td>[% L.input_tag('delivery_zipcode', IMPORT.delivery_zipcode) %]</td>
        </tr>
        <tr>
          <th>[% 'City' | $T8 %]</th>
          <td>[% L.input_tag('delivery_city', IMPORT.delivery_city) %]</td>
        </tr>
        <tr>
          <th>[% 'Country' | $T8 %]</th>
          <td>[% L.input_tag('delivery_country', IMPORT.delivery_country) %]</td>
        </tr>
        <tr>
          <th>[% 'Phone' | $T8 %]</th>
          <td>[% L.input_tag('delivery_phone', IMPORT.delivery_phone) %]</td>
        </tr>
        <tr>
          <th>[% 'Email' | $T8 %]</th>
          <td>[% L.input_tag('delivery_email', IMPORT.delivery_email) %]</td>
        </tr>
        [% IF D_ADDRESS %]
        <tr>
          <th>[% 'Customernumber' | $T8 %]</th>
          <td>[% D_ADDRESS.customernumber %]</td>
        </tr>
        [% ELSE %]
        <tr>
          <td colspan="2">
            [% L.ajax_submit_tag("controller.pl?action=ShopOrder/apply_customer",  "#delivery", LxERP.t8("Apply customer")) %]
          </td>
        </tr>
        [% END %]
      </table>
      </div>
    </form><!-- /#delivery -->
  </div>

</div><!-- /.wrapper -->

<div class="wrapper" id="wrapper-2">

  <div class="input-panel control-panel" style="vertical-align:top">
    <table class="tbl-horizontal">
      <caption>[% 'Shop Headdata' | $T8 %]</caption>
      <tbody>
        <tr>
          <th>[% 'Shop Ordernumber' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.shop_ordernumber) %]</td>
        </tr>
        <tr>
          <th>[% 'Shop Orderdate' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.order_date.dmy('.')) _ ' ' _ HTML.escape(IMPORT.order_date.hms(':')) %]</td>
        </tr>
        <tr>
          <th>[% 'Shop Host' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.host) %]</td>
        </tr>
        <tr>
          <th>[% 'Shop OrderIP' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.remote_ip) %]</td>
        </tr>
        <tr>
          <th>[% 'Shop Ordernotes' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.shop_customer_comment) %]</td>
        </tr>
        <tr>
          <th>[% 'Shop Orderamount' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.amount_as_number) %]</td>
        </tr>
        <tr>
          <th>[% 'Shipping costs' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.shipping_costs_as_number) %]</td>
        </tr>
        <tr>
          <th>[% 'Payment description' | $T8 %]</th>
          <td>[% HTML.escape(IMPORT.payment_description) %]</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="input-panel control-panel" style="vertical-align:top">
    [% IF IMPORT.obsolete %]
      [% L.button_tag %]
      <b>[% 'Shoporder deleted -- ' | $T8 %]</b> <a href="controller.pl?action=ShopOrder/undelete_order&import_id=[% IMPORT.id %]" class="button">[% 'revert deleted' | $T8 %]</a>
    [% ELSE %]
      [% UNLESS IMPORT.transferred %]

        [% IF PROPOSALS %]
          <form method="post" action="controller.pl" id="create_order">
            [% L.hidden_tag('import_id', IMPORT.id) %]

            <table class="tbl-list">
              <caption>[% 'Customer Proposals' | $T8 %]</caption>
              <tbody>
                [% FOREACH prop = PROPOSALS %]
                  [% IF prop.order_lock %]
                    [% #PENDENT: KLASSE statt STYLE verwenden %]
                    [% SET orderlock_class = 'style="background:rgba(232, 32, 23, 0.2);"' %]
                  [% ELSE %]
                    [% SET orderlock_class = '' %]
                  [% END %]
                  <tr [% orderlock_class %]>
                    <td>[% IF !prop.order_lock %][% L.radio_button_tag('customer', value=prop.id) %][% END %]</td>
                    <td>
                      <a href="controller.pl?action=CustomerVendor/edit&id=[% prop.id %]&db=customer&callback=[% HTML.url('controller.pl?action=ShopOrder/show&id=' _ IMPORT.id) %]">
                        [% HTML.escape(prop.customernumber) %]
                      </a>
                    </td>
                    <td>
                      [% IF !prop.notes == '' %]
                        <span class="tooltipster-html" title="[% HTML.escape(prop.notes) %]">
                          <span style="color:red;font-weight: bold;">[% HTML.escape(prop.name) %]</span>
                        </span>
                      [% ELSE %]
                        [% HTML.escape(prop.name) %]
                      [% END %]
                    </td>
                    <td>[% HTML.escape(prop.street)  %]</td>
                    <td>[% HTML.escape(prop.zipcode) %]</td>
                    <td>[% HTML.escape(prop.city)    %]</td>
                    <td>[% HTML.escape(prop.email)   %]</td>
                  </tr>
                [% END %]
              </tbody>
            </table>

            <div id="transfer" style="display:none;">
              [% # 'Customernumber: ' _ %]
              [% L.ajax_submit_tag('controller.pl?action=ShopOrder/transfer', "#create_order", LxERP.t8('Create order')) %]
            </div>

            [% FOREACH prop = PROPOSALS %]
              <div id="shop_update_customer_[% prop.id %]" class="div_hidden" style="display:none;">
                [% L.ajax_submit_tag("controller.pl?action=ShopOrder/apply_customer&cv_id=" _ prop.id,  "#billing", LxERP.t8("Update customer using billing address")) %]
              </div>
            [% END %]

          </form><!-- /#create_order -->
          <div class="buttons">
            <a href="controller.pl?action=ShopOrder/delete_order&import_id=[% IMPORT.id %]" class="button neutral">[% 'delete order' | $T8 %]</a>
          </div>
        [% END # PROPOSALS %]

      [% ELSE %]

        <div>
          <h3>[% 'Transferred' | $T8 %]</h3>
          <div id="recordlinks"></div>
          <script type="text/javascript">
            var url = 'controller.pl?action=RecordLinks/ajax_list&object_model=ShopOrder&object_id=[% IMPORT.id %]';
            $('#recordlinks').load(url);
          </script>
        </div>
      [% END %]
    [% END %]
  </div>
</div>

<div class="wrapper" id="wrapper-3">
  <form method="post" action="controller.pl" id="create_partial_order">
  [% L.hidden_tag('import_id', IMPORT.id) %]
    <table class="tbl-list" style="width:100%">
      <thead>
        <tr>
          <th>[% 'Assign'            | $T8 %]</th>
          <th>[% 'Position'          | $T8 %]</th>
          <th>[% 'Partnumber'        | $T8 %]</th>
          <th>[% 'Partdescriptipion' | $T8 %]</th>
          <th>[% 'Qty'               | $T8 %]</th>
          <th>[% 'Price'             | $T8 %]</th>
          <th>[% 'Discount'          | $T8 %]</th>
          <th>[% 'Promotion Code'    | $T8 %]</th>
          <th>[% 'Extended'          | $T8 %]</th>
        </tr>
      </thead>
      <tbody>
        [% FOREACH pos = IMPORT.shop_order_items %]
          <tr>
            <td>[% L.checkbox_tag("pos_ids." _ pos.id _ "[]", value=1, checked=1) %]</td>
            <td>[% loop.count                                      %]</td>
            <td>[% HTML.escape(pos.partnumber)                     %]</td>
            <td>[% HTML.escape(pos.description)                    %]</td>
            <td>[% pos.quantity_as_number                          %]</td>
            <td>[% pos.price_as_number                             %]</td>
            <td>[% pos.discount_as_number * 100                  %] %</td>
            <td>[% pos.discount_code                               %]</td>
            <td>[% LxERP.format_amount(pos.price * pos.quantity,2) %]</td>
          </tr>
        [% END %]
      </tbody>
    </table>
    <div id="partial_transfer" style="float:left; display:none;">
      [% L.hidden_tag('partial_transfer_customer_id') %]
      [% L.ajax_submit_tag('controller.pl?action=ShopOrder/transfer', "#create_partial_order", LxERP.t8('Create partial order')) %]
    </div>
  </form>
</div>


<script type="text/javascript">
  $("input[type=radio]").change(function(){
    $('.div_hidden').css("display", 'none');
    var cv_id = $("input[type=radio][id="+ this.id + "]").val();
    $('#shop_update_customer_'+ cv_id).css("display", 'block');
    $('#transfer').css("display", 'block');
    $('#partial_transfer').css("display", 'block');
    $('#partial_transfer_customer_id').val(cv_id);
  });
</script>
