[% USE T8 %]
[% USE HTML %]
[% USE LxERP %]
[% USE L %]
[% USE P %]

<div id="parent_variant" class="wrapper">
  <div class="input-panel">
    <table id="variant_value_table" class="tbl-list">
      <caption>
        [% LxERP.t8("Variants") %]
      </caption>
      <thead>
      <tr>
        <th>
          [% L.checkbox_tag("varaint_value_select_all_multi_id",
              checked=0, id='variant_value_select_all'
              alt=LxERP.t8('Select/Deselect all'), title=LxERP.t8('Select/Deselect all'),
            ) %]
        </th>
        <th id="variant_value_partnumber_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("partnumber")'>
            [% 'Partnumber' | $T8 %]
          </a>
        </th>
        <th id="variant_value_ean_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("ean")'>
            [% "EAN" | $T8 %]
          </a>
        </th>
        <th id="variant_value_description_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("description")'>
            [% "Description" | $T8 %]
          </a>
        </th>
        <th id="variant_value_variant_values_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("variant_values")'>
            [% "Property Values (Abbreviation)" | $T8 %]
          </a>
        </th>
        [% FOREACH variant_property = SELF.part.variant_properties %]
        <th id="variant_value_variant_property_[% variant_property.id %]_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("variant_property_[% variant_property.id %]")'>
            [% variant_property.displayable_name %]
          </a>
        </th>
        [% END %]
        <th id="variant_value_listprice_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("listprice")'>
            [% "List Price" | $T8 %]
          </a>
        </th>
        <th id="variant_value_sellprice_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("sellprice")'>
            [% "Sell Price" | $T8 %]
          </a>
        </th>
        <th id="variant_value_lastcost_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("lastcost")'>
            [% "Last Cost" | $T8 %]
          </a>
        </th>
        <th id="variant_value_onhand_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("onhand")'>
            [% "On Hand" | $T8 %]
          </a>
        </th>
        <th id="variant_value_rop_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_values("rop")'>
            [% "ROP" | $T8 %]
          </a>
        </th>
      </tr>
      <tr>
        <th>
          [%- L.button_tag('kivi.Part.variant_rows_toggle_selected();', "ðŸ”„",
                           title=LxERP.t8("Toggle selection"),
                           alt=LxERP.t8("Toggle selection"),
                           ) %]
        </th>
        <th><!-- partnumber --></th>
        <th><!-- ean --></th>
        <th>
          [% L.input_tag("description_for_selected_variants_values", SELF.part.description,
                          class="wi-medium",
                          ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_value("description")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
        <th><!-- variant_values --></th>
        [% FOREACH property = SELF.part.variant_properties %]
        <th></th>
        [% END %]
        <th>
          [% L.input_tag(
                "listprice_as_number_for_selected_variants_values",
                SELF.part.listprice_as_number,
                class="reformat_number numeric wi-small",
          ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_value("listprice_as_number")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
        <th>
          [% L.input_tag(
                "sellprice_as_number_for_selected_variants_values",
                SELF.part.sellprice_as_number,
                class="reformat_number numeric wi-small",
          ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_value("sellprice_as_number")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
        <th>
          [% L.input_tag(
                "lastcost_as_number_for_selected_variants_values",
                SELF.part.lastcost_as_number,
                class="reformat_number numeric wi-small",
          ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_value("lastcost_as_number")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
        <th><!-- onhand --></th>
        <th>
          [% L.input_tag(
                "rop_as_number_for_selected_variants_values",
                SELF.part.rop_as_number,
                class="reformat_number numeric wi-small",
          ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_value("rop_as_number")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
      </tr>
      </thead>
      <tbody class="listrow">
        [% FOREACH variant = SELF.part.variants %]
          <tr class="variant_value_row_entry">
            [% L.hidden_tag("variants_values[+].id", variant.id, id='variant_' _ variant.id) %]
            [% L.hidden_tag("variants_values[].position", loop.count) %]
            <td>
              [% L.checkbox_tag('variant_value_multi_id_' _ loop.count, value=variant.id, checked=0) %]
            </td>
            <td>[% variant.presenter.part %]</td>
            <td>
              [% L.input_tag("variants_values[].ean", variant.ean, class="wi-medium") %]
            </td>
            <td>
              [% L.input_tag("variants_values[].description", variant.description, class="wi-medium") %]
            </td>
            <td>[% variant.variant_values | html %]</td>
            [% FOREACH variant_property = SELF.part.variant_properties %]
            <td> [% variant.variant_value(variant_property).displayable_name %] </td>
            [% END %]
            <td>
              [% L.input_tag(
                    "variants_values[].listprice_as_number",
                    variant.listprice_as_number,
                    class='reformat_number numeric wi-small',
              ) %]
            </td>
            <td>
              [% L.input_tag(
                    "variants_values[].sellprice_as_number",
                    variant.sellprice_as_number,
                    class='reformat_number numeric wi-small',
              ) %]
            </td>
            <td>
              [% L.input_tag(
                    "variants_values[].lastcost_as_number",
                    variant.lastcost_as_number,
                    class='reformat_number numeric wi-small',
              ) %]
            </td>
            <td>
              <span class="data wi-small numeric">
                [% LxERP.format_amount(variant.onhand) %] [% variant.unit | html %]
              </span>
            </td>
            <td>
              [% L.input_tag(
                    "variants_values[].rop_as_number",
                    variant.rop_as_number,
                    class='reformat_number numeric wi-small',
              ) %]
            </td>
          </tr>
        [% END %]
      </tbody>
    </table>
    [% L.button_tag('kivi.Part.update_variants_values();', LxERP.t8("Update Variants")) %]
  </div>

  [% BLOCK panel_1 %]
    <h3> [% LxERP.t8("Create new Variants") %] </h3>
    <div class="wrapper">
    [% FOREACH variant_property = SELF.part.variant_properties %]
      <div class="col input-panel" style="min-width:fit-content;">
        <h4>[% variant_property.displayable_name | html %]</h4>
        [% L.select_tag("variant_properties." _ variant_property.id _ ".selected_property_value_ids[]",
          variant_property.property_values,
          title_key='displayable_name', value_key='id',
          id="selected_property_value_ids_" _ variant_property.id,
          multiple=1,
        ) %]
        [% L.multiselect2side(
          "selected_property_value_ids_" _ variant_property.id,
          labelsx=LxERP.t8("All Property Values"),
          labeldx=LxERP.t8("Selected Property Values")
        ) %]
      </div>
    [% END %]
    </div>
    [% L.button_tag('kivi.Part.create_variants();', LxERP.t8("Create Variants with selected Values")) %]
  [% END %]

  <div class="wrapper">
  [%
    INCLUDE 'common/toggle_panel.html'
    block_name='panel_1'
    toggle_class='panel_1'
    display_status='closed'
    button_closed=LxERP.t8('Show Create new Variants')
    button_open=LxERP.t8('Hide Create new Variants')
  %]
  </div>

  [% BLOCK panel_2 %]
    <h3> [% LxERP.t8("Convert Part to Variant") %] </h3>
    <table class="tbl-list">
      <caption>
        [% 'Variant Properties' | $T8 %]
      </caption>
      <thead>
        <tr>
          [% FOREACH variant_property = SELF.part.variant_properties %]
          <th>[% variant_property.displayable_name | html %]</th>
          [% END %]
        </tr>
      </thead>
      <tbody>
        <tr>
          [% FOREACH variant_property = SELF.part.variant_properties %]
          <td style="vertical-align:top">
            [% L.select_tag("convert_part.variant_properties." _ variant_property.id _ ".selected_property_value_id",
              variant_property.property_values,
              title_key='displayable_name', value_key='id',
              size=variant_property.property_values.size,
            ) %]
          </td>
          [% END %]
        </tr>
      </tbody>
    </table>
    <label for="convert_part.id">[% 'Part for conversion:' | $T8 %]</label>
    [% P.part.picker('convert_part.id', undef,
      part_type=SELF.part.part_type, variant_type='single',
      placeholder=(LxERP.t8('Type:') _ ' ' _ LxERP.t8(SELF.part.part_type)),
      class="wi-wide"
    ) %]
    <br>
    <br>
    [% L.button_tag('kivi.Part.convert_part_to_variant();', LxERP.t8("Convert")) %]
  [% END %]

  <div class="wrapper">
  [%
    INCLUDE 'common/toggle_panel.html'
    block_name='panel_2'
    toggle_class='panel_2'
    display_status='closed'
    button_closed=LxERP.t8('Show Convert Part to Variant')
    button_open=LxERP.t8('Hide Convert Part to Variant')
  %]
  </div>

  <div class="wrapper">
  [%
    INCLUDE 'common/toggle_panel.html'
    block_name='panel_3'
    toggle_class='panel_3'
    display_status='open'
    button_closed=LxERP.t8('Show Edit Properties')
    button_open=LxERP.t8('Hide Edit Properties')
  %]
  </div>

  [% BLOCK panel_3 %]
    <h3> [% LxERP.t8("Edit Properties") %] </h3>
    <table id="variant_property_table" class="tbl-list">
      <caption>
        [% LxERP.t8("Variants") %]
      </caption>
      <thead>
      <tr>
        <th>
          [% L.checkbox_tag("varaint_property_select_all_multi_id",
              checked=0, id='variant_property_select_all'
              alt=LxERP.t8('Select/Deselect all'), title=LxERP.t8('Select/Deselect all'),
            ) %]
        </th>
        <th id="variant_property_partnumber_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_properties("partnumber")'>
            [% 'Partnumber' | $T8 %]
          </a>
        </th>
        <th id="variant_property_ean_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_properties("ean")'>
            [% "EAN" | $T8 %]
          </a>
        </th>
        <th id="variant_property_description_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_properties("description")'>
            [% "Description" | $T8 %]
          </a>
        </th>
        <th id="variant_property_variant_values_header_id">
          <a href='#' onClick='javascript:kivi.Part.reorder_variants_properties("variant_values")'>
            [% "Property Values (Abbreviation)" | $T8 %]
          </a>
        </th>
        [% FOREACH variant_property = SELF.part.variant_properties %]
        <th id="variant_property_variant_property_[% variant_property.id %]_header_id">
          [% L.hidden_tag('variant_property_ids[]', variant_property.id) %]
          <span>
          <a style="color:#e0e0d6"
            href='#' onClick='javascript:kivi.Part.reorder_variants_properties("variant_property_[% variant_property.id %]")'>
            [% variant_property.displayable_name | html %]
          </a>
          [% L.button_tag('kivi.Part.remove_variant_property(this)', 'X'
            title=LxERP.t8('Delete Property'),
            alt=LxERP.t8('Delete Property'),
          )%]
          </span>
        </th>
        [% END %]
        <th>
          [% L.select_tag("add_variant_property", AVAILABLE_VARIANT_PROPERIES
            title_key='displayable_name', value_key='id',
            with_empty=1, empty_title=LxERP.t8("Add Variant Property"),
            onchange='kivi.Part.update_variant_property_value_options();',
          )%]
        </th>
      </tr>
      <tr>
        <th>
          [%- L.button_tag('kivi.Part.variant_property_rows_toggle_selected();', "ðŸ”„",
                           title=LxERP.t8("Toggle selection"),
                           alt=LxERP.t8("Toggle selection"),
                           ) %]
        </th>
        <th><!-- partnumber --></th>
        <th><!-- ean --></th>
        <th><!-- description --></th>
        <th><!-- variant_values --></th>
        [% FOREACH variant_property = SELF.part.variant_properties %]
        <th>
          [% L.select_tag("variant_property_" _ variant_property.id _ "_for_selected_variants_properties",
                variant_property.property_values_sorted
                title_key='displayable_name', value_key='id'
              ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_property("variant_property_' _ variant_property.id _ '")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
        [% END %]
        <th>
          [% L.select_tag("add_variant_property_value_for_selected_variants_properties", []
                title_key='displayable_name', value_key='id',
                with_empty=1, empty_title=LxERP.t8("Select Variant Property First"),
              ) %]
          [%- L.button_tag(
                'kivi.Part.set_selected_variants_to_property("add_variant_property_value")',
                "â†“",
                alt=LxERP.t8('Apply to selected rows'),
                title=LxERP.t8('Apply to selected rows'),
          ) %]
        </th>
      </tr>
      </thead>
      <tbody class="listrow">
        [% FOREACH variant = SELF.part.variants %]
          <tr class="variant_property_row_entry">
            [% L.hidden_tag("variants_properties[+].id", variant.id, id='variant_' _ variant.id) %]
            [% L.hidden_tag("variants_properties[].position", loop.count) %]
            <td>
              [% L.checkbox_tag('variant_property_multi_id_' _ loop.count, value=variant.id, checked=0) %]
            </td>
            <td>[% variant.presenter.part %]</td>
            <td><span class="data wi-medium">
              [% variant.ean | html %]
            </span></td>
            <td><span class="data wi-normal">
              [% variant.description | html %]
            </span></td>
            <td>[% variant.variant_values | html %]</td>
            [% FOREACH variant_property = SELF.part.variant_properties %]
            <td>
              [% L.select_tag("variants_properties[].variant_property_" _ variant_property.id,
                variant_property.property_values_sorted
                title_key='displayable_name', value_key='id',
                default=variant.variant_value(variant_property).id
              ) %]
            </td>
            [% END %]
            <td>
              [% L.select_tag("variants_properties[].add_variant_property_value", []
                title_key='displayable_name', value_key='id',
                with_empty=1, empty_title=LxERP.t8("Select Variant Property First"),
              ) %]
            </td>
          </tr>
        [% END %]
      </tbody>
    </table>
    [% L.button_tag('kivi.Part.update_variants_properties();', LxERP.t8("Update Variants")) %]
  [% END %]

</div>


