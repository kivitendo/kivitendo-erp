[%- USE T8 %]
[%- USE HTML %]
[%- USE LxERP %]
[%- USE L %]
[%- USE P %]

<tbody class="row_entry listrow" data-position="[%- HTML.escape(ITEM.position) -%]"[%- IF MYCONFIG.show_form_details -%] data-expanded="1"[%- END -%]>
  <tr>
    <td align="center">
      [%- IF MYCONFIG.show_form_details %]
        [% L.img_tag(src="image/collapse.svg",
                     alt=LxERP.t8('Hide details'), title=LxERP.t8('Hide details'), class="expand") %]
      [%- ELSE %]
        [% L.img_tag(src="image/expand.svg",
                     alt=LxERP.t8('Show details'), title=LxERP.t8('Show details'), class="expand") %]
      [%- END %]
      [% L.hidden_tag("orderitem_ids[+]", ID) %]
      [% L.hidden_tag("converted_from_record_item_type_ref[+]", ITEM.converted_from_record_item_type_ref) %]
      [% L.hidden_tag("converted_from_record_item_id[+]",       ITEM.converted_from_record_item_id) %]
      [% L.hidden_tag("order.orderitems[+].id", ITEM.id, id='item_' _ ID) %]
      [% L.hidden_tag("order.orderitems[].stock_info", ITEM.stock_info, class="data-stock-info") %]
      [% L.hidden_tag("order.orderitems[].parts_id", ITEM.parts_id) %]
      [% L.hidden_tag("order.orderitems[].sellprice", ITEM.sellprice) %]
      [% L.hidden_tag("order.orderitems[].discount", ITEM.discount) %]
      [% L.hidden_tag("order.orderitems[].ordnumber", ITEM.ordnumber) %]
      [% L.hidden_tag("order.orderitems[].transdate", ITEM.transdate) %]
      [% L.hidden_tag("order.orderitems[].cusordnumber", ITEM.cusordnumber) %]
      [% L.hidden_tag("order.orderitems[].base_qty", ITEM.base_qty) %]
      [% L.hidden_tag("order.orderitems[].lastcost", ITEM.lastcost) %]
      [% L.hidden_tag("order.orderitems[].price_factor_id", ITEM.price_factor_id) %]
      [% L.hidden_tag("order.orderitems[].price_factor", ITEM.price_factor) %]
      [% L.hidden_tag("order.orderitems[].marge_price_factor", ITEM.marge_price_factor) %]
      [% L.hidden_tag("order.orderitems[].pricegroup_id", ITEM.pricegroup_id) %]
      [% L.hidden_tag("order.orderitems[].active_price_source", ITEM.active_price_source.source) %]
      [% L.hidden_tag("order.orderitems[].active_discount_source", ITEM.active_discount_source.source) %]
    </td>
    <td>
      <div name="position" class="numeric">
        [% HTML.escape(ITEM.position) %]
      </div>
    </td>
    <td align="center">
      <img src="image/updown.png" alt="[%- LxERP.t8('reorder item') %]" class="dragdrop">
    </td>
    <td align="center">
      [%- L.button_tag("kivi.DeliveryOrder.delete_order_item_row(this)",
                       LxERP.t8("X"),
                       confirm=LxERP.t8("Are you sure?")) %]
    </td>
    [%- IF SELF.show_update_button -%]
    <td align="center">
      [%- L.img_tag(src="image/rotate_cw.svg",
                    alt=LxERP.t8('Update from master data'),
                    title= LxERP.t8('Update from master data'),
                    onclick="if (!confirm('" _ LxERP.t8("Are you sure to update this position from master data?") _ "')) return false; kivi.DeliveryOrder.update_row_from_master_data(this);",
                    id='update_from_master') %]
    </td>
    [%- END -%]
    <td>
      <div name="partnumber">
        [%- P.link_tag(SELF.url_for(controller='Part', action='edit', 'part.id'=ITEM.part.id), ITEM.part.partnumber, target="_blank", title=LxERP.t8('Open in new window')) -%]
      </div>
    </td>
    [%- IF SELF.search_cvpartnumber -%]
    <td>
      <div name="cvpartnumber">[% HTML.escape(ITEM.cvpartnumber) %]</div>
    </td>
    [%- END -%]
    <td>
      <div name="partclassification">[% ITEM.part.presenter.typeclass_abbreviation %]</div>
    </td>
    <td>
      [% L.areainput_tag("order.orderitems[].description",
                     ITEM.description,
                     size='40',
                     style='width: 300px') %]
      [%- L.hidden_tag("order.orderitems[].longdescription", ITEM.longdescription) %]
      [%- L.button_tag("kivi.DeliveryOrder.show_longdescription_dialog(this)", LxERP.t8("L")) %]
    </td>
    [%- IF (SELF.type == "sales_order" || SELF.type == "purchase_order") -%]
    <td nowrap>
      [%- L.div_tag(LxERP.format_amount(ITEM.shipped_qty, 2, 0) _ ' ' _ ITEM.unit, name="shipped_qty", class="numeric") %]
    </td>
    [%- END -%]
    <td nowrap>
      [%- L.input_tag("order.orderitems[].qty_as_number",
                      ITEM.qty_as_number,
                      size = 5,
                      class="reformat_number numeric") %]
      [%- IF ITEM.part.formel -%]
        [%- L.button_tag("kivi.DeliveryOrder.show_calculate_qty_dialog(this)", LxERP.t8("*/")) %]
        [%- L.hidden_tag("formula[+]", ITEM.part.formel) -%]
      [%- END -%]
    </td>
    <td nowrap>
      [%- L.select_tag("order.orderitems[].unit",
                      ITEM.part.available_units,
                      default = ITEM.unit,
                      title_key = 'name',
                      value_key = 'name',
                      class = 'unitselect') %]
    </td>

    <td>
      <span id="stock_[% ID %]" class="data-stock-qty">[% SELF.calculate_stock_in_out(ITEM) %] [% ITEM.unit %]</span>
      [% P.button_tag("kivi.DeliveryOrder.open_stock_in_out_dialog(this, '" _ in_out _"')", "?") %]
    </td>
  </tr>

  <tr [%- IF !MYCONFIG.show_form_details -%]style="display:none"[%- END -%]>
    <td colspan="100%">
      [%- IF MYCONFIG.show_form_details || ITEM.render_second_row %]
        <div name="second_row" data-loaded="1">
          [%- PROCESS delivery_order/tabs/_second_row.html ITEM=ITEM TYPE=SELF.type %]
        </div>
      [%- ELSE %]
        <div name="second_row" id="second_row_[% ID %]">
          [%- LxERP.t8("Loading...") %]
        </div>
      [%- END %]
    </td>
  </tr>

</tbody>
